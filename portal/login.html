<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — LizOn Portal</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./assets/portal.css" />
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">LizOn Education</div>
          <div class="brandSub">Student Portal</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnInstall">Add to Home Screen</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="h1">Login</div>
        <p class="p">Use the same email you registered with LizOn.</p>
        <div class="hr"></div>

        <button class="btn btnPrimary" id="btnGoogle" style="width:100%;">Continue with Google</button>

        <div class="hr"></div>

        <form id="loginForm">
          <div class="field">
            <label>Email</label>
            <input class="input" id="email" type="email" placeholder="name@email.com" required />
          </div>
   
<div class="field">
  <label>Password</label>

  <div class="inputWrap">
    <input class="input" id="password" type="password" placeholder="Your password" required />

    <button class="iconBtn" id="togglePass" type="button" aria-label="Show password">
      <!-- eye icon (SVG) -->
      <svg id="eyeOpen" width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="2"/>
        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
      </svg>

      <!-- eye-off icon (SVG) -->
      <svg id="eyeClosed" style="display:none;" width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M3 3l18 18" stroke="currentColor" stroke-width="2"/>
        <path d="M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42" stroke="currentColor" stroke-width="2"/>
        <path d="M6.2 6.2C3.8 8 2 12 2 12s3.5 7 10 7c2.1 0 3.9-.5 5.4-1.3" stroke="currentColor" stroke-width="2"/>
        <path d="M9.5 4.5A9.6 9.6 0 0 1 12 5c6.5 0 10 7 10 7s-1.2 2.4-3.6 4.4" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>
  </div>

  <div id="loginMsg" class="msgBox" style="display:none;"></div>
</div>


          <div class="row">
            <button class="btn btnPrimary" type="submit">Login</button>
            <button class="btn" type="button" id="btnReset">Reset Password</button>
          </div>

          <div class="hr"></div>
          <div class="notice noticeWarn">
            <div style="font-weight:900;">Important</div>
            <div class="mini">
              This portal is invite-only. If your email is not added by LizOn admin, you won’t get access even if you try to login.
            </div>
          </div>

          <div class="mini" style="margin-top:10px;">
            Tip: Your phone can save password automatically after first login.
          </div>
        </form>
      </div>

      <div class="card">
        <div class="h1">How access works</div>
        <p class="p">Admin adds your email once, then you can login anytime. If you can’t login, contact LizOn support.</p>
        <div class="hr"></div>
        <div class="mini">
          <b>iPhone:</b> Safari → Share → Add to Home Screen<br/>
          <b>Android:</b> Chrome → Menu → Add to Home screen / Install app
        </div>
        <div class="hr"></div>
        <div class="mini">
          If you are a teacher/admin, use the same email LizOn admin added for you.
        </div>
      </div>
    </div>
  </div>
<script type="module">
import { sb, getMyProfile } from "./assets/portal.js";

// Elements
const passInput = document.getElementById("password");
const togglePass = document.getElementById("togglePass");
const eyeOpen = document.getElementById("eyeOpen");
const eyeClosed = document.getElementById("eyeClosed");
const loginMsg = document.getElementById("loginMsg");

// ---------------------------
// Password toggle (clean)
// ---------------------------
togglePass.addEventListener("click", () => {
  const isHidden = passInput.type === "password";
  passInput.type = isHidden ? "text" : "password";

  eyeOpen.style.display = isHidden ? "none" : "block";
  eyeClosed.style.display = isHidden ? "block" : "none";
});

// ---------------------------
// Helper: Show Message
// ---------------------------
function showMsg(text, type = "info") {
  loginMsg.style.display = "block";
  loginMsg.className = "msgBox " + type;
  loginMsg.textContent = text;
}

// ---------------------------
// If already logged in
// ---------------------------
const { data: sess } = await sb.auth.getSession();
if (sess.session) location.href = "./index.html";

// ---------------------------
// Google Login
// ---------------------------
document.getElementById("btnGoogle").addEventListener("click", async () => {
  const { error } = await sb.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: location.origin + "/portal/index.html" }
  });

  if (error) showMsg(error.message, "error");
});

// ---------------------------
// Email + Password Login
// ---------------------------
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  showMsg("Checking credentials...", "info");

  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = passInput.value;

  const { data, error } = await sb.auth.signInWithPassword({ email, password });

  if (error) {
    if (error.message.toLowerCase().includes("invalid login credentials")) {
      showMsg("Wrong email or password.", "error");
    } else {
      showMsg(error.message, "error");
    }
    return;
  }

  const profile = await getMyProfile(data.user);

  if (!profile || profile.status !== "active") {
    showMsg("Your portal access is not active yet.", "error");
    await sb.auth.signOut();
    return;
  }

  showMsg("Login successful! Redirecting...", "success");

  setTimeout(() => {
    location.href = "./index.html";
  }, 900);
});

// ---------------------------
// Reset Password
// ---------------------------
document.getElementById("btnReset").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim().toLowerCase();

  if (!email) {
    showMsg("Enter your email first.", "error");
    return;
  }

  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: location.origin + "/portal/login.html"
  });

  if (error) {
    showMsg(error.message, "error");
    return;
  }

  showMsg("Password reset email sent.", "success");
});
</script>

</body>
</html>



