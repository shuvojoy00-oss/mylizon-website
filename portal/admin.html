<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — LizOn Portal</title>
  <link rel="stylesheet" href="./assets/portal.css"/>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">LizOn Education</div>
          <div class="brandSub">Admin Panel</div>
        </div>
      </div>
      <div class="pills">
        <span class="pill" id="pillName">Name: …</span>
        <span class="pill" id="pillRole">Role: …</span>
        <button class="btn btnDanger" id="btnLogout">Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="sectionTitle">Enroll a Student</div>
        <div class="mini">Student must exist in <b>profiles</b> table.</div>
        <div class="hr"></div>

        <form id="enrollForm">
          <div class="field">
            <label>Student Email</label>
            <input class="input" id="studentEmail" type="email" placeholder="student@email.com" required />
          </div>

          <div class="field">
            <label>Course</label>
            <select class="input" id="course"></select>
          </div>

          <!-- ✅ NEW: Teacher assign -->
          <div class="field">
            <label>Assign Teacher (optional)</label>
            <select class="input" id="teacher"></select>
            <div class="mini" style="margin-top:6px;">If empty, student won’t appear on any teacher dashboard.</div>
          </div>

          <div class="field">
            <label>Batch Month (Group only)</label>
            <input class="input" id="batch" placeholder="2026-01" />
            <div class="mini" style="margin-top:6px;">Required for group courses. Leave empty for 1:1.</div>
          </div>

          <div class="field">
            <label>Meet Link</label>
            <input class="input" id="meet" placeholder="https://meet.google.com/xxx-xxxx-xxx" />
          </div>

          <div class="field">
            <label>Notes Link</label>
            <input class="input" id="notes" placeholder="https://drive.google.com/..." />
          </div>

          <div class="field">
            <label>Homework Link</label>
            <input class="input" id="homework" placeholder="https://forms.gle/..." />
          </div>

          <div class="field">
            <label>Recordings Link</label>
            <input class="input" id="recordings" placeholder="https://drive.google.com/..." />
          </div>

          <div class="row">
            <button class="btn btnPrimary" type="submit">Save Enrollment</button>
          </div>
        </form>

        <div class="hr"></div>
        <div id="msg" class="mini"></div>
      </div>

      <div class="card">
        <div class="sectionTitle">Quick Checks</div>
        <div class="mini">If student sees empty courses: enrollments row missing OR status not active.</div>
        <div class="hr"></div>
        <div class="mini">
          Recommended: keep Meet/Notes/Homework/Recordings as Google Drive / Forms links per batch.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { sb, requireActiveProfile, logout } from "./assets/portal.js";
    import { COURSES } from "./config.js";

    document.getElementById("btnLogout").addEventListener("click", logout);

    const pack = await requireActiveProfile();
    if (!pack) throw new Error("No session");

    const role = (pack.profile.role || "").toLowerCase();
    if (role !== "admin" && role !== "super_admin") location.href = "./index.html";

    document.getElementById("pillName").textContent = "Name: " + (pack.profile.full_name || "Admin");
    document.getElementById("pillRole").textContent = "Role: " + (pack.profile.role || "admin");

    // Fill course dropdown (never empty)
    const sel = document.getElementById("course");
    sel.innerHTML = COURSES.map(c => `<option value="${c.id}">${c.label}</option>`).join("");

    const msg = document.getElementById("msg");

    // ✅ NEW: Load teachers into dropdown (role=teacher)
    const tSel = document.getElementById("teacher");
    tSel.innerHTML = `<option value="">-- No teacher assigned --</option>`;

    const { data: teachers, error: tErr } = await sb
      .from("profiles")
      .select("id,full_name,email")
      .eq("role", "teacher")
      .eq("status", "active")
      .order("full_name", { ascending: true });

    if (tErr) {
      // If teachers fetch fails, keep dropdown with default option
      console.warn("Teacher load failed:", tErr.message);
    } else if (teachers && teachers.length) {
      tSel.innerHTML += teachers.map(t =>
        `<option value="${t.id}">${(t.full_name || t.email)}</option>`
      ).join("");
    }

    document.getElementById("enrollForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "Saving...";

      const email = document.getElementById("studentEmail").value.trim().toLowerCase();
      const course = document.getElementById("course").value;
      const batch = document.getElementById("batch").value.trim();
      const meet = document.getElementById("meet").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const homework = document.getElementById("homework").value.trim();
      const recordings = document.getElementById("recordings").value.trim();

      // ✅ NEW: Teacher selection
      const teacherId = document.getElementById("teacher").value || null;
      const teacherObj = teacherId ? (teachers?.find(t => t.id === teacherId)) : null;
      const teacherName = teacherObj ? (teacherObj.full_name || teacherObj.email) : null;

      // Find student profile by email
      const { data: prof, error: pErr } = await sb.from("profiles")
        .select("id,email,full_name,status")
        .eq("email", email)
        .maybeSingle();

      if (pErr || !prof) {
        msg.textContent = "Student not found in profiles. Add to profiles first.";
        return;
      }
      if (prof.status !== "active") {
        msg.textContent = "Student profile is not active.";
        return;
      }

      // Insert enrollment (student_id only) + student_name + teacher_id + teacher_name
      const { error } = await sb.from("enrollments").insert([{
        student_id: prof.id,
        student_name: prof.full_name || null,

        teacher_id: teacherId,
        teacher_name: teacherName,

        course,
        batch_month: batch || null,
        meet_link: meet || null,
        notes_link: notes || null,
        homework_link: homework || null,
        recordings_link: recordings || null,
        status: "active"
      }]);

      if (error) {
        msg.textContent = "Failed: " + error.message;
        return;
      }

      msg.textContent = "Enrollment saved ✅";
      e.target.reset();

      // Keep teacher dropdown populated after reset
      document.getElementById("teacher").value = "";
    });
  </script>
</body>
</html>
