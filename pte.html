<script>
  // ----------------------------
  // Helpers
  // ----------------------------
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

  function lockScroll(lock){
    document.body.style.overflow = lock ? 'hidden' : '';
  }

  function openOverlay(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
    lockScroll(true);
  }
  function closeOverlay(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
    lockScroll(false);
  }

  function openPop(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
    lockScroll(true);
  }
  function closePop(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
    lockScroll(false);
  }

  // ----------------------------
  // Menu
  // ----------------------------
  const menuSheet = $('#menuSheet');
  $('#menuBtn').addEventListener('click', ()=> openOverlay('menuSheet'));
  $('#menuFab').addEventListener('click', ()=> openOverlay('menuSheet'));
  $('#menuClose').addEventListener('click', ()=> closeOverlay('menuSheet'));
  menuSheet.addEventListener('click', (e)=>{ if(e.target === menuSheet) closeOverlay('menuSheet'); });

  // ----------------------------
  // Theme toggle
  // ----------------------------
  const themeBtn = $('#themeBtn');
  const root = document.documentElement;

  function setTheme(t){
    root.setAttribute('data-theme', t);
    localStorage.setItem('mylizon_theme', t);
  }
  setTheme(localStorage.getItem('mylizon_theme') || 'dark');

  themeBtn.addEventListener('click', ()=>{
    const cur = root.getAttribute('data-theme') || 'dark';
    setTheme(cur === 'dark' ? 'light' : 'dark');
  });

  // ----------------------------
  // Video modal
  // ----------------------------
  const videoPop = $('#videoPop');
  const videoFrame = $('#videoFrame');

  function openVideo(id, title){
    $('.pop-title', $('#videoPop')).textContent = title || 'Video';
    videoFrame.src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
    openPop('videoPop');
  }

  function closeVideo(){
    videoFrame.src = '';
    closePop('videoPop');
  }

  $('#videoClose').addEventListener('click', closeVideo);
  videoPop.addEventListener('click', (e)=>{ if(e.target === videoPop) closeVideo(); });

  $$('.video-wrap .play-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const wrap = e.currentTarget.closest('.video-wrap');
      if(!wrap) return;
      openVideo(wrap.getAttribute('data-video'), wrap.getAttribute('data-title'));
    });
  });

  // ----------------------------
  // Mistake Popup ONLY (Early popup removed)
  // ----------------------------
  const mistakePop = $('#mistakePop');

  $('#mistakePopClose').addEventListener('click', ()=> closePop('mistakePop'));
  $('#mistakePopClose2').addEventListener('click', ()=> closePop('mistakePop'));
  mistakePop.addEventListener('click', (e)=>{ 
    if(e.target === mistakePop) closePop('mistakePop'); 
  });

  let mistakeShown = false;
  window.addEventListener('scroll', ()=>{
    if(mistakeShown) return;
    if(window.scrollY > 650){
      mistakeShown = true;
      setTimeout(()=> openPop('mistakePop'), 900);
    }
  }, { passive:true });

  // ----------------------------
  // Payment Sheet
  // ----------------------------
  $$('#payment [data-pay]').forEach(btn=>{
    btn.addEventListener('click', ()=> openOverlay('paymentSheet'));
  });

  const paymentSheet = $('#paymentSheet');
  $('#paymentClose').addEventListener('click', ()=> closeOverlay('paymentSheet'));
  $('#payBack').addEventListener('click', ()=> closeOverlay('paymentSheet'));
  paymentSheet.addEventListener('click', (e)=>{ if(e.target === paymentSheet) closeOverlay('paymentSheet'); });

  $('#copyAll').addEventListener('click', async ()=>{
    const text = [
      'PTE Course Fee: 9000tk',
      'Payment: Choose method → pay → send screenshot/Txn ID on WhatsApp (01611611139)',
      'WhatsApp: https://wa.me/8801611611139'
    ].join('\n');

    try{
      await navigator.clipboard.writeText(text);
      $('#copyAll').textContent = 'Copied';
      setTimeout(()=> $('#copyAll').textContent = 'Copy all', 1200);
    }catch(e){
      $('#copyAll').textContent = 'Copy failed';
      setTimeout(()=> $('#copyAll').textContent = 'Copy all', 1200);
    }
  });

  // ----------------------------
  // Smooth anchor scroll
  // ----------------------------
  $$('a[href^="#"]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      const href = a.getAttribute('href');
      if(!href || href === '#') return;

      const target = document.querySelector(href);
      if(target){
        e.preventDefault();
        const headerOffset = 92;
        window.scrollTo({
          top: target.getBoundingClientRect().top + window.scrollY - headerOffset,
          behavior:'smooth'
        });
      }
    });
  });
</script>
