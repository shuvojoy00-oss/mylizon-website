<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — LizOn Portal</title>
  <link rel="stylesheet" href="./assets/portal.css"/>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">LizOn Education</div>
          <div class="brandSub">Admin Dashboard</div>
        </div>
      </div>
      <div class="rightPills">
        <span class="badge" id="pillName">Name: …</span>
        <span class="badge" id="pillRole">Role: …</span>
        <button class="btn" id="btnLogout">Logout</button>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="h1">Enroll a Student</div>
      <p class="p">Student must exist in <b>profiles</b> table.</p>
      <div class="hr"></div>

      <form id="enrollForm">
        <div class="field">
          <label>Student Email</label>
          <input class="input" id="studentEmail" type="email" placeholder="student@email.com" required />
        </div>

        <div class="field">
          <label>Course</label>
          <select id="courseSelect" required></select>
        </div>

        <div class="field">
          <label>Batch Month (Group only)</label>
          <input class="input" id="batchMonth" placeholder="2026-01" />
          <div class="mini">Required for group courses. Leave empty for 1:1.</div>
        </div>

        <div class="field">
          <label>Meet Link</label>
          <input class="input" id="meetLink" placeholder="https://meet.google.com/..." />
        </div>

        <div class="field">
          <label>Notes Link</label>
          <input class="input" id="notesLink" placeholder="https://drive.google.com/..." />
        </div>

        <div class="field">
          <label>Homework Link</label>
          <input class="input" id="homeworkLink" placeholder="https://forms.gle/..." />
        </div>

        <div class="field">
          <label>Recordings Link</label>
          <input class="input" id="recordingsLink" placeholder="https://drive.google.com/..." />
        </div>

        <div class="row">
          <button class="btn btnPrimary" type="submit">Save Enrollment</button>
          <span class="mini" id="statusTxt"></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="h1">Recent Enrollments</div>
      <p class="p">Last 10 enrollments (by student_id).</p>
      <div class="hr"></div>
      <div id="listBox" class="empty">Loading…</div>
    </div>
  </div>

  <script type="module">
    import { sb, getMyProfileOrLogout, requireRole, logout } from "./assets/portal.js";
    import { COURSES } from "./config.js";

    document.getElementById("btnLogout").addEventListener("click", logout);

    const pack = await getMyProfileOrLogout();
    if(!pack) throw new Error("No access");
    if(!requireRole(pack.profile.role, ["admin","super_admin"])) throw new Error("Not allowed");

    document.getElementById("pillName").textContent = "Name: " + (pack.profile.full_name || "Admin");
    document.getElementById("pillRole").textContent = "Role: " + pack.profile.role;

    // Populate courses ALWAYS (no empty dropdown problem)
    const courseSel = document.getElementById("courseSelect");
    courseSel.innerHTML = COURSES.map(c => `<option value="${c.id}">${c.label}</option>`).join("");

    const statusTxt = document.getElementById("statusTxt");
    const listBox = document.getElementById("listBox");

    async function refreshList(){
      const res = await sb.from("enrollments")
        .select("student_id,course,batch_month,status")
        .order("created_at",{ascending:false})
        .limit(10);

      if(res.error){
        listBox.textContent = "Could not load enrollments.";
        return;
      }
      const rows = res.data || [];
      if(!rows.length){ listBox.textContent = "No enrollments yet."; return; }

      listBox.innerHTML = rows.map(r=>`
        <div class="courseCard" style="margin:10px 0;">
          <div>
            <div class="courseTitle">${escapeHtml(r.course||"-")}</div>
            <div class="courseMeta">student_id: ${escapeHtml(r.student_id||"-")}</div>
          </div>
          <div class="courseMeta">Batch: ${escapeHtml(r.batch_month||"-")} • ${escapeHtml(r.status||"-")}</div>
        </div>
      `).join("");
    }

    await refreshList();

    document.getElementById("enrollForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      statusTxt.textContent = "Saving…";

      const email = document.getElementById("studentEmail").value.trim().toLowerCase();
      const course = courseSel.value;
      const batch_month = document.getElementById("batchMonth").value.trim() || null;

      // lookup student profile by email to get student_id
      const p = await sb.from("profiles").select("id,email,status").eq("email", email).maybeSingle();
      if(p.error || !p.data){
        statusTxt.textContent = "";
        return alert("Student not found in profiles. Add student first.");
      }
      if(p.data.status !== "active"){
        statusTxt.textContent = "";
        return alert("Student status not active.");
      }

      const payload = {
        student_id: p.data.id,
        course,
        batch_month,
        meet_link: document.getElementById("meetLink").value.trim() || null,
        notes_link: document.getElementById("notesLink").value.trim() || null,
        homework_link: document.getElementById("homeworkLink").value.trim() || null,
        recordings_link: document.getElementById("recordingsLink").value.trim() || null,
        status: "active"
      };

      const ins = await sb.from("enrollments").insert(payload);
      if(ins.error){
        statusTxt.textContent = "";
        return alert("Insert failed: " + ins.error.message);
      }

      statusTxt.textContent = "Saved ✅";
      await refreshList();
    });

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
