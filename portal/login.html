<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login ‚Äî LizOn Portal</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./assets/portal.css" />
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">LizOn Education</div>
          <div class="brandSub">Student Portal</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnInstall">Add to Home Screen</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="h1">Login</div>
        <p class="p">Use the same email you registered with LizOn.</p>
        <div class="hr"></div>

        <button class="btn btnPrimary" id="btnGoogle" style="width:100%;">Continue with Google</button>

        <div class="hr"></div>

        <form id="loginForm">
          <div class="field">
            <label>Email</label>
            <input class="input" id="email" type="email" placeholder="name@email.com" required />
          </div>
      <div class="field">
  <label>Password</label>
  <div style="position:relative;">
    <input class="input" id="password" type="password" placeholder="Your password" required />
    <span id="togglePass"
      style="position:absolute; right:12px; top:50%; transform:translateY(-50%);
             cursor:pointer; font-size:14px; user-select:none;">
      üëÅ
    </span>
  </div>
</div>

<div id="loginMsg" class="mini" style="margin-top:10px;"></div>


          <div class="row">
            <button class="btn btnPrimary" type="submit">Login</button>
            <button class="btn" type="button" id="btnReset">Reset Password</button>
          </div>

          <div class="hr"></div>
          <div class="notice noticeWarn">
            <div style="font-weight:900;">Important</div>
            <div class="mini">
              This portal is invite-only. If your email is not added by LizOn admin, you won‚Äôt get access even if you try to login.
            </div>
          </div>

          <div class="mini" style="margin-top:10px;">
            Tip: Your phone can save password automatically after first login.
          </div>
        </form>
      </div>

      <div class="card">
        <div class="h1">How access works</div>
        <p class="p">Admin adds your email once, then you can login anytime. If you can‚Äôt login, contact LizOn support.</p>
        <div class="hr"></div>
        <div class="mini">
          <b>iPhone:</b> Safari ‚Üí Share ‚Üí Add to Home Screen<br/>
          <b>Android:</b> Chrome ‚Üí Menu ‚Üí Add to Home screen / Install app
        </div>
        <div class="hr"></div>
        <div class="mini">
          If you are a teacher/admin, use the same email LizOn admin added for you.
        </div>
      </div>
    </div>
  </div>
<script type="module">
import { sb, getMyProfile } from "./assets/portal.js";

// Password toggle
const passInput = document.getElementById("password");
const togglePass = document.getElementById("togglePass");

togglePass.addEventListener("click", () => {
  if (passInput.type === "password") {
    passInput.type = "text";
    togglePass.textContent = "üôà";
  } else {
    passInput.type = "password";
    togglePass.textContent = "üëÅ";
  }
});

// Message box
const loginMsg = document.getElementById("loginMsg");

// If already logged in
const { data: sess } = await sb.auth.getSession();
if (sess.session) location.href = "./index.html";

// Google OAuth
document.getElementById("btnGoogle").addEventListener("click", async () => {
  const { error } = await sb.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: location.origin + "/portal/index.html" }
  });
  if (error) {
    loginMsg.textContent = error.message;
    loginMsg.style.color = "red";
  }
});

// Email + password login
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  loginMsg.textContent = "Checking...";
  loginMsg.style.color = "#666";

  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = passInput.value;

  const { data, error } = await sb.auth.signInWithPassword({ email, password });

  if (error) {
    loginMsg.style.color = "red";

    if (error.message.toLowerCase().includes("invalid login credentials")) {
      loginMsg.textContent = "Wrong email or password.";
    } else {
      loginMsg.textContent = error.message;
    }
    return;
  }

  // Invite-only check
  const profile = await getMyProfile(data.user);

  if (!profile || profile.status !== "active") {
    loginMsg.style.color = "red";
    loginMsg.textContent = "Your portal access is not active yet.";
    await sb.auth.signOut();
    return;
  }

  loginMsg.style.color = "green";
  loginMsg.textContent = "Login successful! Redirecting...";

  setTimeout(() => {
    location.href = "./index.html";
  }, 800);
});

// Reset password
document.getElementById("btnReset").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim().toLowerCase();
  if (!email) {
    loginMsg.style.color = "red";
    loginMsg.textContent = "Enter your email first.";
    return;
  }

  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: location.origin + "/portal/login.html"
  });

  if (error) {
    loginMsg.style.color = "red";
    loginMsg.textContent = error.message;
    return;
  }

  loginMsg.style.color = "green";
  loginMsg.textContent = "Password reset email sent.";
});
</script>

</body>
</html>

