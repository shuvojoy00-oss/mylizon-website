<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LizOn Education — Placement Admin</title>

  <style>
    :root{
      --bg:#0F2E26;
      --bg2:#153B30;
      --card:#12362D;
      --text:#EAF4F1;
      --muted:rgba(234,244,241,.70);
      --line:rgba(234,244,241,.12);
      --good:#19b37a;
      --good2:#0ea56f;
      --danger:#ff5b5b;
      --warn:#ffc857;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(900px 600px at 50% 0%, var(--bg2) 0%, var(--bg) 55%);
      color:var(--text);
      min-height:100vh;
    }
    .top{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      position:sticky;top:0;
      backdrop-filter: blur(10px);
      background:rgba(15,46,38,.65);
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .pill{
      font-size:12px;
      padding:4px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:18px}
    .card{
      background:linear-gradient(180deg, rgba(18,54,45,.92), rgba(18,54,45,.72));
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input{
      width:360px;max-width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      color:var(--text);
      outline:none;
    }
    input:focus{border-color:rgba(25,179,122,.55)}
    .btn{
      padding:12px 14px;border-radius:12px;
      border:1px solid rgba(25,179,122,.35);
      background:linear-gradient(180deg, var(--good), var(--good2));
      color:#061b14;font-weight:700;
      cursor:pointer;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn2{
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      color:var(--text);
      cursor:pointer;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:10px}
    .err{color:var(--danger);font-size:12px;margin-left:10px}
    .ok{color:var(--good);font-size:12px;margin-left:10px}
    .mt{margin-top:14px}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
    }
    th{color:var(--muted);font-weight:600;text-align:left;background:rgba(0,0,0,.10)}
    tr:last-child td{border-bottom:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding:8px 10px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
    }
    .mini.danger{border-color:rgba(255,91,91,.5);color:#ffd3d3}
    .badge{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;
      display:inline-flex;gap:6px;align-items:center;
      background:rgba(0,0,0,.08);
    }
    .sp{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .w160{width:160px}
    .w140{width:140px}
  </style>
</head>
<body>

  <div class="top">
    <div class="brand">
      <span>LizOn Education</span>
      <span class="pill">Placement Admin</span>
    </div>
    <div class="right">
      <span id="who" class="badge">Not logged in</span>
      <button id="logoutBtn" class="btn2" style="display:none;">Logout</button>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN CARD -->
    <div id="loginCard" class="card">
      <div style="font-weight:700;margin-bottom:10px;">Staff Login</div>

      <div class="row">
        <div>
          <label>Password</label>
          <input id="pass" type="password" placeholder="Admin password" autocomplete="current-password"/>
        </div>
        <button id="loginBtn" class="btn">Login</button>
        <span id="loginMsg" class="err"></span>
      </div>

      <div class="hint">
        Security note: this admin talks to Neon through server API (safe). Never store DB passwords in HTML.
      </div>
    </div>

    <!-- DASHBOARD CARD -->
    <div id="dashCard" class="card mt" style="display:none;">
      <div class="sp">
        <div>
          <div style="font-weight:700;">Placement Attempts</div>
          <div class="small">Edit or delete attempts. Delete is permanent.</div>
        </div>
        <div class="right">
          <span class="badge">Table: public.ielts_placement_attempts</span>
          <button id="refreshBtn" class="btn2">Refresh</button>
        </div>
      </div>

      <div id="dashMsg" class="small mt"></div>

      <table>
        <thead>
          <tr>
            <th style="width:170px;">Time</th>
            <th style="width:190px;">Name</th>
            <th style="width:140px;">Phone</th>
            <th style="width:90px;">Target</th>
            <th style="width:160px;">Timeline</th>
            <th style="width:130px;">Stage</th>
            <th style="width:110px;">Status</th>
            <th style="width:160px;">Action</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="8" class="small">Loading…</td></tr>
        </tbody>
      </table>
    </div>

  </div>

<script>
  // ===== CONFIG =====
  const API_LOGIN = "/api/admin-login";
  const API_ATTEMPTS = "/api/admin-attempts";
  const LS_TOKEN_KEY = "ADMIN_TOKEN";

  // ===== HELPERS =====
  const $ = (id) => document.getElementById(id);
  const who = $("who");
  const loginCard = $("loginCard");
  const dashCard = $("dashCard");
  const loginBtn = $("loginBtn");
  const logoutBtn = $("logoutBtn");
  const refreshBtn = $("refreshBtn");
  const loginMsg = $("loginMsg");
  const dashMsg = $("dashMsg");
  const rowsEl = $("rows");
  const passEl = $("pass");

  function setWho(text){
    who.textContent = text;
  }

  function token(){
    return localStorage.getItem(LS_TOKEN_KEY);
  }

  function setToken(t){
    localStorage.setItem(LS_TOKEN_KEY, t);
  }

  function clearToken(){
    localStorage.removeItem(LS_TOKEN_KEY);
  }

  function showLogin(msg=""){
    loginCard.style.display = "";
    dashCard.style.display = "none";
    logoutBtn.style.display = "none";
    setWho("Not logged in");
    loginMsg.textContent = msg || "";
  }

  function showDash(){
    loginCard.style.display = "none";
    dashCard.style.display = "";
    logoutBtn.style.display = "";
    setWho("Admin");
    loginMsg.textContent = "";
  }

async function apiFetch(url, opts={}){
  const headers = Object.assign({}, opts.headers || {});
  const t = token();

  if (t) {
    headers["x-admin-token"] = t; 
    headers["authorization"] = "Bearer " + t;
  }

  if (opts.body && !headers["content-type"]) {
    headers["content-type"] = "application/json";
  }

  const res = await fetch(url, Object.assign({}, opts, { headers }));

  let data = null;
  try { data = await res.json(); } catch(e) {}

  if (!res.ok) {
    const err = (data && (data.error || data.message)) || ("HTTP " + res.status);
    throw new Error(err);
  }

  return data;
}


  function fmtTime(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString();
    }catch(e){ return iso || ""; }
  }

  // ===== DASHBOARD RENDER =====
  function renderRows(list){
    if (!list || !list.length){
      rowsEl.innerHTML = `<tr><td colspan="8" class="small">No attempts yet.</td></tr>`;
      return;
    }

    rowsEl.innerHTML = list.map(r => `
      <tr data-id="${r.id}">
        <td>${fmtTime(r.created_at)}</td>
        <td><input class="w160" data-k="full_name" value="${escapeHtml(r.full_name||"")}" /></td>
        <td><input class="w140" data-k="phone" value="${escapeHtml(r.phone||"")}" /></td>
        <td><input class="w140" data-k="target_score" value="${escapeHtml(r.target_score||"")}" /></td>
        <td><input class="w160" data-k="exam_timeline" value="${escapeHtml(r.exam_timeline||"")}" /></td>
        <td><input class="w140" data-k="stage" value="${escapeHtml(r.stage||"")}" /></td>
        <td><input class="w140" data-k="status" value="${escapeHtml(r.status||"")}" /></td>
        <td>
          <div class="actions">
            <button class="mini" data-act="save">Save</button>
            <button class="mini danger" data-act="del">Delete</button>
          </div>
        </td>
      </tr>
    `).join("");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadAttempts(){
    dashMsg.textContent = "Loading…";
    const data = await apiFetch(API_ATTEMPTS, { method:"GET" });
    renderRows(data.rows);
    dashMsg.textContent = `Loaded ${data.rows.length} row(s).`;
  }

  function readRowInputs(tr){
    const id = Number(tr.getAttribute("data-id"));
    const obj = { id };
    tr.querySelectorAll("input[data-k]").forEach(inp=>{
      obj[inp.getAttribute("data-k")] = inp.value;
    });
    return obj;
  }

  async function saveRow(tr){
    const payload = readRowInputs(tr);
    dashMsg.textContent = "Saving…";
    await apiFetch(API_ATTEMPTS, { method:"PATCH", body: JSON.stringify(payload) });
    dashMsg.textContent = "Saved.";
  }

  async function deleteRow(tr){
    const id = Number(tr.getAttribute("data-id"));
    const ok = confirm("Delete this attempt permanently?");
    if (!ok) return;
    dashMsg.textContent = "Deleting…";
    await apiFetch(API_ATTEMPTS, { method:"DELETE", body: JSON.stringify({ id }) });
    tr.remove();
    dashMsg.textContent = "Deleted.";
  }

  // ===== EVENTS =====
  loginBtn.addEventListener("click", async ()=>{
    loginBtn.disabled = true;
    loginMsg.textContent = "";
    try{
      const password = passEl.value || "";
      const res = await fetch(API_LOGIN, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ password })
      });
      const data = await res.json().catch(()=>null);

      if (!res.ok || !data || !data.ok) {
        throw new Error((data && (data.error || data.message)) || "Login failed");
      }

      // ✅ store token for API calls
      setToken(data.token);

      showDash();
      await loadAttempts();

    }catch(e){
      clearToken();
      showLogin(e.message || "Login error");
    }finally{
      loginBtn.disabled = false;
    }
  });

  logoutBtn.addEventListener("click", ()=>{
    clearToken();
    showLogin("");
  });

  refreshBtn.addEventListener("click", async ()=>{
    try{
      await loadAttempts();
    }catch(e){
      // if token becomes invalid, force login
      clearToken();
      showLogin("Session expired. Please login again.");
    }
  });

  rowsEl.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const tr = btn.closest("tr[data-id]");
    if (!tr) return;

    const act = btn.getAttribute("data-act");
    try{
      if (act === "save") await saveRow(tr);
      if (act === "del") await deleteRow(tr);
    }catch(err){
      if ((err.message||"").toLowerCase().includes("unauthorized")){
        clearToken();
        showLogin("Unauthorized. Please login again.");
      }else{
        dashMsg.textContent = "Error: " + (err.message || err);
      }
    }
  });

  // ===== AUTO-BOOT =====
  (async function init(){
    // only try dashboard if token already exists
    if (token()){
      try{
        showDash();
        await loadAttempts();
      }catch(e){
        clearToken();
        showLogin("");
      }
    } else {
      showLogin("");
    }
  })();
</script>

</body>
</html>
