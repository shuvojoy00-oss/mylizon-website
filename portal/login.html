<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login â€” LizOn Portal</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./assets/portal.css" />
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">LizOn Education</div>
          <div class="brandSub">Student Portal</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnInstall">Add to Home Screen</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="h1">Login</div>
        <p class="p">Use the same email you registered with LizOn.</p>
        <div class="hr"></div>

        <button class="btn btnPrimary" id="btnGoogle" style="width:100%;">Continue with Google</button>

        <div class="hr"></div>

        <form id="loginForm">
          <div class="field">
            <label>Email</label>
            <input class="input" id="email" type="email" placeholder="name@email.com" required />
          </div>
   
<div class="field">
  <label>Password</label>

  <div class="inputWrap">
    <input class="input" id="password" type="password" placeholder="Your password" required />

    <button class="iconBtn" id="togglePass" type="button" aria-label="Show password">
      <!-- eye icon (SVG) -->
      <svg id="eyeOpen" width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="2"/>
        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
      </svg>

      <!-- eye-off icon (SVG) -->
      <svg id="eyeClosed" style="display:none;" width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M3 3l18 18" stroke="currentColor" stroke-width="2"/>
        <path d="M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42" stroke="currentColor" stroke-width="2"/>
        <path d="M6.2 6.2C3.8 8 2 12 2 12s3.5 7 10 7c2.1 0 3.9-.5 5.4-1.3" stroke="currentColor" stroke-width="2"/>
        <path d="M9.5 4.5A9.6 9.6 0 0 1 12 5c6.5 0 10 7 10 7s-1.2 2.4-3.6 4.4" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>
  </div>

  <div id="loginMsg" class="msgBox" style="display:none;"></div>
</div>


          <div class="row">
            <button class="btn btnPrimary" type="submit">Login</button>
            <button class="btn" type="button" id="btnReset">Reset Password</button>
          </div>

          <div class="hr"></div>
          <div class="notice noticeWarn">
            <div style="font-weight:900;">Important</div>
            <div class="mini">
              This portal is invite-only. If your email is not added by LizOn admin, you wonâ€™t get access even if you try to login.
            </div>
          </div>

          <div class="mini" style="margin-top:10px;">
            Tip: Your phone can save password automatically after first login.
          </div>
        </form>
      </div>

      <div class="card">
        <div class="h1">How access works</div>
        <p class="p">Admin adds your email once, then you can login anytime. If you canâ€™t login, contact LizOn support.</p>
        <div class="hr"></div>
        <div class="mini">
          <b>iPhone:</b> Safari â†’ Share â†’ Add to Home Screen<br/>
          <b>Android:</b> Chrome â†’ Menu â†’ Add to Home screen / Install app
        </div>
        <div class="hr"></div>
        <div class="mini">
          If you are a teacher/admin, use the same email LizOn admin added for you.
        </div>
      </div>
    </div>
  </div>
<script type="module">
import { sb, getMyProfile } from "./assets/portal.js";

// Password toggle
const passInput = document.getElementById("password");
const togglePass = document.getElementById("togglePass");

togglePass.addEventListener("click", () => {
  if (passInput.type === "password") {
    passInput.type = "text";
    togglePass.textContent = "ðŸ™ˆ";
  } else {
    passInput.type = "password";
    togglePass.textContent = "ðŸ‘";
  }
});

// Message box
const loginMsg = document.getElementById("loginMsg");

// If already logged in
const { data: sess } = await sb.auth.getSession();
if (sess.session) location.href = "./index.html";

// Google OAuth
document.getElementById("btnGoogle").addEventListener("click", async () => {
  const { error } = await sb.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: location.origin + "/portal/index.html" }
  });
  if (error) {
    loginMsg.textContent = error.message;
    loginMsg.style.color = "red";
  }
});

// Email + password login
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  loginMsg.textContent = "Checking...";
  loginMsg.style.color = "#666";

  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = passInput.value;

  const { data, error } = await sb.auth.signInWithPassword({ email, password });

  if (error) {
    loginMsg.style.color = "red";

    if (error.message.toLowerCase().includes("invalid login credentials")) {
      loginMsg.textContent = "Wrong email or password.";
    } else {
      loginMsg.textContent = error.message;
    }
    return;
  }

  // Invite-only check
  const profile = await getMyProfile(data.user);

  if (!profile || profile.status !== "active") {
    loginMsg.style.color = "red";
    loginMsg.textContent = "Your portal access is not active yet.";
    await sb.auth.signOut();
    return;
  }

  loginMsg.style.color = "green";
  loginMsg.textContent = "Login successful! Redirecting...";

  setTimeout(() => {
    location.href = "./index.html";
  }, 800);
});

// Reset password
document.getElementById("btnReset").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim().toLowerCase();
  if (!email) {
    loginMsg.style.color = "red";
    loginMsg.textContent = "Enter your email first.";
    return;
  }

  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: location.origin + "/portal/login.html"
  });

  if (error) {
    loginMsg.style.color = "red";
    loginMsg.textContent = error.message;
    return;
  }

  loginMsg.style.color = "green";
  loginMsg.textContent = "Password reset email sent.";
});
</script>

</body>
</html>


