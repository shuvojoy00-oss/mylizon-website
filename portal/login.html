<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — LizOn Portal</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./assets/portal.css" />
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">LizOn Education</div>
          <div class="brandSub">Student Portal</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnInstall">Add to Home Screen</button>
      </div>
    </div>

    <div class="grid">
      <div class="card half">
        <div class="h1">Login</div>
        <p class="p">Use the same email you registered with LizOn.</p>
        <div class="hr"></div>

        <button class="btn btnPrimary" id="btnGoogle" style="width:100%;">Continue with Google</button>

        <div class="hr"></div>

        <form id="loginForm">
          <div class="field">
            <label>Email</label>
            <input class="input" id="email" type="email" placeholder="name@email.com" required />
          </div>
          <div class="field">
            <label>Password</label>
            <input class="input" id="password" type="password" placeholder="Your password" required />
          </div>

          <div class="row">
            <button class="btn btnPrimary" type="submit">Login</button>
            <button class="btn" type="button" id="btnReset">Reset Password</button>
          </div>

          <div class="hr"></div>
          <div class="notice noticeWarn">
            <div style="font-weight:800;">Important</div>
            <div class="mini">
              This portal is invite-only. If your email is not added by LizOn admin, you won’t get access even if you try to login.
            </div>
          </div>

          <div class="mini" style="margin-top:10px;">
            Tip: Your phone can save password automatically after first login.
          </div>
        </form>
      </div>

      <div class="card half">
        <div class="h1">How access works</div>
        <p class="p">
          Admin adds your email once, then you can login anytime.
          If you can’t login, contact LizOn support.
        </p>
        <div class="hr"></div>

        <div class="mini">
          <b>iPhone:</b> Safari → Share → Add to Home Screen<br/>
          <b>Android:</b> Chrome → Menu → Add to Home screen / Install app
        </div>

        <div class="hr"></div>
        <div class="mini">
          If you are a teacher/admin, use the same email LizOn admin added for you.
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script type="module">
    import { createClient } from "./assets/supabase.js";
    import { logout } from "./assets/portal.js";

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }

    const sb = createClient();

    // Install button logic
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });
    document.getElementById("btnInstall").addEventListener("click", async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt = null;
      } else {
        alert("iPhone: Share → Add to Home Screen\nAndroid: Menu → Add to Home screen / Install app");
      }
    });

    // If already logged in, redirect by role
    const { data } = await sb.auth.getSession();
    if (data.session) location.href = "./index.html";

    // Google OAuth
    document.getElementById("btnGoogle").addEventListener("click", async () => {
      const { error } = await sb.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: location.origin + "/portal/index.html" }
      });
      if (error) alert(error.message);
    });

    // Email+password login
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim().toLowerCase();
      const password = document.getElementById("password").value;

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);

      // after auth, check portal profile exists and active
      const { data: profile, error: pErr } = await sb.from("profiles").select("role,status").eq("id", data.user.id).single();
      if (pErr || !profile || profile.status !== "active") {
        alert("Your portal access is not active yet. Contact LizOn admin.");
        await sb.auth.signOut();
        return;
      }
      location.href = "./index.html";
    });

    // Reset password (email)
    document.getElementById("btnReset").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim().toLowerCase();
      if (!email) return alert("Enter your email first.");
      const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: location.origin + "/portal/login.html"
      });
      if (error) return alert(error.message);
      alert("Password reset email sent. Check inbox/spam.");
    });
  </script>
</body>
</html>
